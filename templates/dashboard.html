<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitcoin ATH Distance Analyzer</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .stat-value { font-size: 2em; font-weight: bold; color: #F7931A; }
        .stat-label { color: #666; margin-top: 5px; }
                 .chart-container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
         .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; }
         .time-range-buttons { display: flex; gap: 5px; }
         .time-btn { padding: 8px 12px; border: 1px solid #ddd; background: white; cursor: pointer; border-radius: 4px; font-size: 12px; transition: all 0.2s; }
         .time-btn:hover { background: #f0f0f0; }
         .time-btn.active { background: #F7931A; color: white; border-color: #F7931A; }
         .loading { text-align: center; padding: 40px; color: #666; }
         .error { color: #e74c3c; text-align: center; padding: 20px; }
         .update-time { text-align: center; color: #666; font-size: 0.9em; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸš€ Bitcoin All-Time High Distance Analyzer</h1>
            <p>Real-time analysis of Bitcoin's proximity to its all-time high</p>
        </div>
        
        <div id="loading" class="loading">Loading analysis data...</div>
        <div id="error" class="error" style="display:none;"></div>
        
        <div id="content" style="display:none;">
            <!-- Enhanced Statistics Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="current-distance">-</div>
                    <div class="stat-label">Current Distance from ATH</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="percentile-rank">-</div>
                    <div class="stat-label">Percentile Rank</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="current-price">-</div>
                    <div class="stat-label">Current Price</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="dollar-difference">-</div>
                    <div class="stat-label">Dollars Below ATH</div>
                </div>
            </div>

            <!-- Statistical Analysis Dashboard -->
            <div class="chart-container" id="volatility-dashboard" style="display: none; margin-bottom: 25px;">
                <h3 style="text-align: center; margin-bottom: 20px; color: #333;">ðŸ“Š Statistical Analysis Dashboard</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div class="volatility-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);">
                        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">ðŸ“ˆ Standard Deviation</div>
                        <div id="vol-std" style="font-size: 24px; font-weight: bold; margin-bottom: 5px;">-</div>
                        <div style="font-size: 12px; opacity: 0.8;">Typical spread from average</div>
                    </div>
                    <div class="volatility-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 4px 15px rgba(240, 147, 251, 0.3);">
                        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">ðŸ“Š Coefficient of Variation</div>
                        <div id="vol-cv" style="font-size: 24px; font-weight: bold; margin-bottom: 5px;">-</div>
                        <div style="font-size: 12px; opacity: 0.8;">Relative volatility measure</div>
                    </div>
                    <div class="volatility-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);">
                        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">ðŸŽ¯ Current Position</div>
                        <div id="vol-position" style="font-size: 24px; font-weight: bold; margin-bottom: 5px;">-</div>
                        <div style="font-size: 12px; opacity: 0.8;">Standard deviations from mean</div>
                    </div>
                    <div class="volatility-card" id="volatility-zone-card" style="padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);">
                        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">ðŸŽª Statistical Zone</div>
                        <div id="vol-zone" style="font-size: 20px; font-weight: bold; margin-bottom: 5px;">-</div>
                        <div style="font-size: 12px; opacity: 0.8;" id="vol-zone-desc">-</div>
                    </div>
                </div>
            </div>
            
            <div class="chart-container">
                <div class="chart-header">
                    <h3 id="chart-title">Distance from ATH Over Time (Last 365 Days)</h3>
                    <div class="time-range-buttons">
                        <button class="time-btn" data-days="7">7D</button>
                        <button class="time-btn" data-days="30">1M</button>
                        <button class="time-btn" data-days="90">3M</button>
                        <button class="time-btn" data-days="180">6M</button>
                        <button class="time-btn active" data-days="365">1Y</button>
                        <button class="time-btn" data-days="1825">5Y</button>
                        <button class="time-btn" data-days="3650">10Y</button>
                        <button class="time-btn" data-days="-1">ALL</button>
                    </div>
                </div>
                <div id="historical-chart"></div>
            </div>
            
            <div class="chart-container">
                <h3>Distribution of Distance from ATH</h3>
                <p style="color: #666; margin-bottom: 15px;">Shows how many days Bitcoin has spent at each distance from its all-time high</p>
                <div id="distribution-chart"></div>
            </div>
            
            <div class="chart-container">
                <h3>Cumulative Distribution</h3>
                <p style="color: #666; margin-bottom: 15px;">Shows what percentage of days have been at or below each distance from ATH</p>
                <div id="cumulative-chart"></div>
            </div>
            
            <div class="update-time" id="update-time"></div>
        </div>
    </div>

    <script>
        async function loadData() {
            try {
                // Load current analysis
                const analysisResponse = await fetch('/api/current-analysis');
                const analysisData = await analysisResponse.json();
                
                if (!analysisData.success) {
                    throw new Error(analysisData.error);
                }
                
                // Store analysis data globally for use in distribution chart
                window.currentAnalysisData = analysisData.data;
                
                // Update UI
                document.getElementById('current-distance').textContent = analysisData.data.current_distance_from_ath.toFixed(2) + '%';
                document.getElementById('percentile-rank').textContent = analysisData.data.percentile_rank.toFixed(1) + 'th';
                document.getElementById('current-price').textContent = '$' + analysisData.data.current_price.toLocaleString();
                document.getElementById('dollar-difference').textContent = '$' + analysisData.data.dollar_difference_from_ath.toLocaleString();
                
                if (analysisData.last_updated) {
                    document.getElementById('update-time').textContent = 'Last updated: ' + new Date(analysisData.last_updated).toLocaleString();
                }
                
                // Load historical chart with default 1Y range
                loadChart(365);
                
                // Load distribution chart
                loadDistributionChart();
                
                // Load cumulative distribution chart
                loadCumulativeChart();
                
                // Show content
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';
                
            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent = 'Error loading data: ' + error.message;
            }
        }
        
        async function loadChart(days) {
            try {
                const url = days === -1 ? '/api/historical-data?days=-1' : `/api/historical-data?days=${days}`;
                const histResponse = await fetch(url);
                const histData = await histResponse.json();
                
                if (histData.success) {
                    const trace = {
                        x: histData.data.dates,
                        y: histData.data.distances,
                        type: 'scatter',
                        mode: 'lines',
                        name: 'Distance from ATH',
                        line: { color: '#F7931A', width: 2 }
                    };
                    
                    const layout = {
                        xaxis: { title: 'Date' },
                        yaxis: { title: 'Distance from ATH (%)' },
                        margin: { t: 20, r: 20, b: 40, l: 60 }
                    };
                    
                    Plotly.newPlot('historical-chart', [trace], layout, {responsive: true});
                    
                    // Update chart title
                    const titles = {
                        7: '7 Days',
                        30: '1 Month',
                        90: '3 Months', 
                        180: '6 Months',
                        365: '1 Year',
                        1825: '5 Years',
                        3650: '10 Years',
                        [-1]: 'All Time'
                    };
                    document.getElementById('chart-title').textContent = `Distance from ATH Over Time (${titles[days] || 'Custom'})`;
                }
            } catch (error) {
                console.error('Error loading chart:', error);
            }
        }
        
        async function loadDistributionChart() {
            try {
                const response = await fetch('/api/distribution-histogram');
                const data = await response.json();
                
                if (data.success) {
                    const trace = {
                        x: data.data.bin_centers,
                        y: data.data.counts,
                        type: 'bar',
                        name: 'Number of Days',
                        marker: {
                            color: '#F7931A',
                            opacity: 0.7,
                            line: {
                                color: '#E6851F',
                                width: 1
                            }
                        }
                    };
                    
                    // Add vertical lines for mean and median
                    const meanLine = {
                        x: [data.data.mean_distance, data.data.mean_distance],
                        y: [0, Math.max(...data.data.counts)],
                        type: 'scatter',
                        mode: 'lines',
                        name: `Mean: ${data.data.mean_distance.toFixed(1)}%`,
                        line: { color: 'red', width: 2, dash: 'dash' }
                    };
                    
                    const medianLine = {
                        x: [data.data.median_distance, data.data.median_distance],
                        y: [0, Math.max(...data.data.counts)],
                        type: 'scatter',
                        mode: 'lines',
                        name: `Median: ${data.data.median_distance.toFixed(1)}%`,
                        line: { color: 'green', width: 2, dash: 'dash' }
                    };
                    
                    const layout = {
                        xaxis: { 
                            title: 'Distance from ATH (%)',
                            range: [0, Math.max(...data.data.bin_centers) * 1.05]
                        },
                        yaxis: { title: 'Number of Days' },
                        margin: { t: 20, r: 20, b: 60, l: 60 },
                        showlegend: true,
                        legend: { x: 0.7, y: 0.9 }
                    };
                    
                    // Add volatility bands (Â±1 and Â±2 standard deviations)
                    const volatilityBands = [];
                    const maxCount = Math.max(...data.data.counts);
                    
                    // Â±2 std bands (light gray)
                    if (data.data.volatility_bands.mean_minus_2std > 0) {
                        volatilityBands.push({
                            x: [data.data.volatility_bands.mean_minus_2std, data.data.volatility_bands.mean_minus_2std],
                            y: [0, maxCount],
                            type: 'scatter',
                            mode: 'lines',
                            name: 'Â±2Ïƒ bands',
                            line: { color: 'lightgray', width: 1, dash: 'dot' },
                            showlegend: false
                        });
                    }
                    
                    volatilityBands.push({
                        x: [data.data.volatility_bands.mean_plus_2std, data.data.volatility_bands.mean_plus_2std],
                        y: [0, maxCount],
                        type: 'scatter',
                        mode: 'lines',
                        name: 'Â±2Ïƒ range',
                        line: { color: 'lightgray', width: 1, dash: 'dot' }
                    });
                    
                    // Â±1 std bands (darker gray)
                    volatilityBands.push({
                        x: [data.data.volatility_bands.mean_minus_1std, data.data.volatility_bands.mean_minus_1std],
                        y: [0, maxCount],
                        type: 'scatter',
                        mode: 'lines',
                        name: 'Â±1Ïƒ bands',
                        line: { color: 'gray', width: 1, dash: 'dot' },
                        showlegend: false
                    });
                    
                    volatilityBands.push({
                        x: [data.data.volatility_bands.mean_plus_1std, data.data.volatility_bands.mean_plus_1std],
                        y: [0, maxCount],
                        type: 'scatter',
                        mode: 'lines',
                        name: 'Â±1Ïƒ range',
                        line: { color: 'gray', width: 1, dash: 'dot' }
                    });
                    
                    const allTraces = [trace, meanLine, medianLine, ...volatilityBands];
                    Plotly.newPlot('distribution-chart', allTraces, layout, {responsive: true});
                    
                    // Add current position line if we have analysis data
                    if (window.currentAnalysisData) {
                        const currentDistance = window.currentAnalysisData.current_distance_from_ath;
                        const currentLine = {
                            x: [currentDistance, currentDistance],
                            y: [0, Math.max(...data.data.counts)],
                            type: 'scatter',
                            mode: 'lines',
                            name: `Current: ${currentDistance.toFixed(1)}%`,
                            line: { color: 'blue', width: 3 }
                        };
                        
                        Plotly.addTraces('distribution-chart', [currentLine]);
                    }
                    
                    // Update enhanced dashboards
                    updateVolatilityDashboard(data.data);
                }
            } catch (error) {
                console.error('Error loading distribution chart:', error);
            }
        }
        
        async function loadCumulativeChart() {
            try {
                const response = await fetch('/api/distribution-histogram');
                const data = await response.json();
                
                if (data.success) {
                    const trace = {
                        x: data.data.cumulative_distances,
                        y: data.data.cumulative_percentages,
                        type: 'scatter',
                        mode: 'lines',
                        name: 'Cumulative %',
                        line: { color: '#F7931A', width: 2 },
                        fill: 'tonexty',
                        fillcolor: 'rgba(247, 147, 26, 0.1)'
                    };
                    
                    // Add current position line
                    let traces = [trace];
                    
                    if (window.currentAnalysisData) {
                        const currentDistance = window.currentAnalysisData.current_distance_from_ath;
                        const currentPercentile = window.currentAnalysisData.percentile_rank;
                        
                        const currentLine = {
                            x: [currentDistance, currentDistance],
                            y: [0, 100],
                            type: 'scatter',
                            mode: 'lines',
                            name: `Current: ${currentDistance.toFixed(1)}% (${currentPercentile.toFixed(1)}th percentile)`,
                            line: { color: 'blue', width: 3, dash: 'dash' }
                        };
                        
                        const currentPoint = {
                            x: [currentDistance],
                            y: [currentPercentile],
                            type: 'scatter',
                            mode: 'markers',
                            name: 'Current Position',
                            marker: { color: 'red', size: 10, symbol: 'circle' }
                        };
                        
                        traces.push(currentLine, currentPoint);
                    }
                    
                    const layout = {
                        xaxis: { 
                            title: 'Distance from ATH (%)',
                            range: [0, Math.max(...data.data.cumulative_distances) * 1.05]
                        },
                        yaxis: { 
                            title: 'Cumulative Percentage (%)',
                            range: [0, 105]
                        },
                        margin: { t: 20, r: 20, b: 60, l: 60 },
                        showlegend: true,
                        legend: { x: 0.02, y: 0.98, bgcolor: 'rgba(255,255,255,0.8)' }
                    };
                    
                    Plotly.newPlot('cumulative-chart', traces, layout, {responsive: true});
                }
            } catch (error) {
                console.error('Error loading cumulative chart:', error);
            }
        }
        
        function updateVolatilityDashboard(distributionData) {
            if (!window.currentAnalysisData) return;
            
            const currentDistance = window.currentAnalysisData.current_distance_from_ath;
            const mean = distributionData.mean_distance;
            const std = distributionData.std_distance;
            const cv = distributionData.coefficient_of_variation;
            
            // Calculate how many standard deviations from mean
            const stdFromMean = (currentDistance - mean) / std;
            
            // Determine volatility zone
            let zone, zoneColor, zoneGradient;
            if (Math.abs(stdFromMean) < 1) {
                zone = "Normal Range";
                zoneColor = "#28a745";
                zoneGradient = "linear-gradient(135deg, #28a745 0%, #20c997 100%)";
            } else if (Math.abs(stdFromMean) < 2) {
                zone = "Unusual Range";
                zoneColor = "#ffc107";
                zoneGradient = "linear-gradient(135deg, #ffc107 0%, #ffca2c 100%)";
            } else {
                zone = "Extreme Range";
                zoneColor = "#dc3545";
                zoneGradient = "linear-gradient(135deg, #dc3545 0%, #fd7e14 100%)";
            }
            
            // Update volatility dashboard
            document.getElementById('vol-std').textContent = std.toFixed(1) + '%';
            document.getElementById('vol-cv').textContent = cv.toFixed(1) + '%';
            document.getElementById('vol-position').textContent = `${stdFromMean.toFixed(1)}Ïƒ ${stdFromMean < 0 ? 'below' : 'above'}`;
            document.getElementById('vol-zone').textContent = zone;
            document.getElementById('vol-zone-desc').textContent = `${Math.abs(stdFromMean).toFixed(1)}Ïƒ from average`;
            
            // Update zone card background
            const zoneCard = document.getElementById('volatility-zone-card');
            zoneCard.style.background = zoneGradient;
            zoneCard.style.color = 'white';
            
            // Show the volatility dashboard
            document.getElementById('volatility-dashboard').style.display = 'block';
        }
        
        // Load data when page loads
        loadData();
        
        // Add event listeners for time range buttons
        document.addEventListener('DOMContentLoaded', function() {
            const timeButtons = document.querySelectorAll('.time-btn');
            timeButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // Remove active class from all buttons
                    timeButtons.forEach(btn => btn.classList.remove('active'));
                    
                    // Add active class to clicked button
                    this.classList.add('active');
                    
                    // Load chart with selected time range
                    const days = parseInt(this.getAttribute('data-days'));
                    loadChart(days);
                });
            });
        });
        
        // Refresh data every 5 minutes
        setInterval(loadData, 5 * 60 * 1000);
    </script>
</body>
</html>
